{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<h1 class="page-title text-center" data-aos="fade-down">Warp Gate Dashboard</h1>

<!-- Stat Cards -->
<div class="row g-4 justify-content-center mb-5">
  <div class="col-md-4" data-aos="fade-up" data-aos-delay="100">
    <div class="glass-card text-center glow-hover p-4">
      <i class="fas fa-layer-group fa-2x text-primary mb-2"></i>
      <h3 class="text-white">{{ stats.total }}</h3>
      <p class="text-muted">Total Cards</p>
    </div>
  </div>
  <div class="col-md-4" data-aos="fade-up" data-aos-delay="200">
    <div class="glass-card text-center glow-hover p-4">
      <i class="fas fa-cube fa-2x text-info mb-2"></i>
      <h3 class="text-white">{{ stats.base }}</h3>
      <p class="text-muted">Base Forms</p>
    </div>
  </div>
  <div class="col-md-4" data-aos="fade-up" data-aos-delay="300">
    <div class="glass-card text-center glow-hover p-4">
      <i class="fas fa-bolt fa-2x text-warning mb-2"></i>
      <h3 class="text-white">{{ stats.awakened }}</h3>
      <p class="text-muted">Awakened Forms</p>
    </div>
  </div>
</div>

<!-- Chart -->
<div class="glass-card mb-5 p-4" data-aos="zoom-in">
  <canvas id="formChart"></canvas>
</div>

<!-- Recent Cards -->
<h4 class="mb-3 text-white" data-aos="fade-right">Recently Added Cards</h4>
{% if stats.recent %}
  <div class="row g-4">
    {% for c in stats.recent %}
      <div class="col-md-6" data-aos="fade-up">
        <div class="glass-card p-3 glow-hover" role="button" data-bs-toggle="modal" data-bs-target="#previewModal"
             data-id="{{ c.id }}" data-name="{{ c.character_name }}" data-form="{{ c.form }}" data-date="{{ c.created_at }}">
          <strong class="text-white">#{{ c.id }}</strong> â€” <span class="text-white">{{ c.character_name }}</span>
          <small class="text-muted">({{ c.form|capitalize }})</small><br>
          <small class="text-muted">Added: {{ c.created_at }}</small>
        </div>
      </div>
    {% endfor %}
  </div>
{% else %}
  <div class="glass-card text-center text-muted py-4" data-aos="fade-up">
    <i class="fas fa-info-circle fa-2x mb-2"></i>
    <p>No cards added yet. Use <strong>Add Card</strong> to begin.</p>
  </div>
{% endif %}

<!-- Pending Submissions -->
<h4 class="mb-3 text-white mt-5 text-center" data-aos="fade-down">Pending Submissions</h4>
{% if stats.pending %}
  <div class="d-flex flex-wrap justify-content-center gap-4">
    {% for card in stats.pending %}
      <div class="glass-card p-3" style="max-width: 420px;" data-aos="fade-up">
        <img src="{{ card.image_url }}" alt="Card Image" class="img-fluid mb-3 rounded">
        <h5 class="text-info">{{ card.title }}</h5>
        <p class="text-light">{{ card.description }}</p>
        <p class="text-muted"><strong>Form:</strong> {{ card.form_type|capitalize }}</p>
        <p class="text-muted"><strong>Submitted by:</strong> {{ card.submitted_by }}</p>
        <form method="POST" action="{{ url_for('admin_dashboard') }}" class="d-flex justify-content-between">
          <input type="hidden" name="card_id" value="{{ card.id }}">
          <button name="action" value="approved" class="btn btn-success">Approve</button>
          <button name="action" value="rejected" class="btn btn-danger">Decline</button>
        </form>
      </div>
    {% endfor %}
  </div>
{% else %}
  <div class="glass-card text-center text-muted py-4 mx-auto" style="max-width: 500px;" data-aos="fade-up">
    <i class="fas fa-inbox fa-2x mb-2"></i>
    <p>No pending submissions. Cards submitted by Card Makers will appear here.</p>
  </div>
{% endif %}

<!-- Modal Preview -->
<div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-light">
      <div class="modal-header border-secondary">
        <h5 class="modal-title" id="previewModalLabel">Card Preview</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p><strong>ID:</strong> <span id="modalId"></span></p>
        <p><strong>Name:</strong> <span id="modalName"></span></p>
        <p><strong>Form:</strong> <span id="modalForm"></span></p>
        <p><strong>Created:</strong> <span id="modalDate"></span></p>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  const ctx = document.getElementById('formChart')?.getContext('2d');
  if (ctx) {
    new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ['Base', 'Awakened', 'Event'],
        datasets: [{
          data: [{{ stats.base }}, {{ stats.awakened }}, {{ stats.event }}],
          backgroundColor: ['#3498db', 'gold', '#e91e63']
        }]
      },
      options: {
        plugins: {
          legend: { labels: { color: '#fff' } }
        }
      }
    });
  }

  const previewModal = document.getElementById('previewModal');
  previewModal.addEventListener('show.bs.modal', event => {
    const trigger = event.relatedTarget;
    document.getElementById('modalId').textContent = trigger.dataset.id;
    document.getElementById('modalName').textContent = trigger.dataset.name;
    document.getElementById('modalForm').textContent = trigger.dataset.form;
    document.getElementById('modalDate').textContent = trigger.dataset.date;
  });
</script>
{% endblock %}
