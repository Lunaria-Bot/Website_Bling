{% extends "base.html" %}
{% block title %}Admin Dashboard{% endblock %}

{% block content %}
  <h2 class="mb-5 text-center dashboard-title">Welcome to the Control Center</h2>

  <!-- Stats Row -->
  <div class="row g-4 mb-5">
    <div class="col-md-3">
      <div class="stat-card">
        <div class="stat-number" id="totalCards">{{ stats.total }}</div>
        <div>Total Cards</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="stat-card">
        <div class="stat-number" id="commonCards">{{ stats.common }}</div>
        <div>Common</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="stat-card">
        <div class="stat-number" id="rareCards">{{ stats.rare }}</div>
        <div>Rare</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="stat-card">
        <div class="stat-number" id="epicCards">{{ stats.epic }}</div>
        <div>Epic</div>
      </div>
    </div>
  </div>

  <!-- Chart -->
  <div class="row mb-5">
    <div class="col-md-6 offset-md-3">
      <canvas id="rarityChart"></canvas>
    </div>
  </div>

  <!-- Recent Activity -->
  <h3 class="mb-3">🕒 Recent Activity</h3>
  {% for c in stats.recent %}
    <div class="recent-card" style="animation-delay: {{ loop.index0 * 0.1 }}s">
      <strong>#{{ c.id }}</strong> — {{ c.name }}
      <small class="text-muted">({{ c.rarity|capitalize }}, ⭐{{ c.potential }})</small><br>
      <small>Added: {{ c.created_at }}</small>
    </div>
  {% else %}
    <p>No recent cards.</p>
  {% endfor %}

  <!-- Links -->
  <div class="row g-4 mt-4">
    <div class="col-md-4">
      <div class="card bg-dark text-white shadow-sm h-100">
        <div class="card-body text-center">
          <h5 class="card-title">➕ Add Card</h5>
          <p class="card-text">Insert new cards into the database with all rarities.</p>
          <a href="{{ url_for('add_card') }}" class="btn btn-primary">Go</a>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card bg-dark text-white shadow-sm h-100">
        <div class="card-body text-center">
          <h5 class="card-title">📜 Card History</h5>
          <p class="card-text">Browse and filter recently added cards.</p>
          <a href="{{ url_for('history') }}" class="btn btn-primary">Go</a>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card bg-dark text-white shadow-sm h-100">
        <div class="card-body text-center">
          <h5 class="card-title">⚙️ Manage</h5>
          <p class="card-text">Future section for managing users, admins, or settings.</p>
          <a href="#" class="btn btn-secondary disabled">Coming Soon</a>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const stats = {
      total: {{ stats.total }},
      common: {{ stats.common }},
      rare: {{ stats.rare }},
      epic: {{ stats.epic }},
      legendary: {{ stats.legendary }}
    };

    function animateValue(id, start, end, duration) {
      const obj = document.getElementById(id);
      let startTimestamp = null;
      const step = (timestamp) => {
        if (!startTimestamp) startTimestamp = timestamp;
        const progress = Math.min((timestamp - startTimestamp) / duration, 1);
        obj.innerText = Math.floor(progress * (end - start) + start);
        if (progress < 1) window.requestAnimationFrame(step);
      };
      window.requestAnimationFrame(step);
    }

    animateValue("totalCards", 0, stats.total, 1500);
    animateValue("commonCards", 0, stats.common, 1500);
    animateValue("rareCards", 0, stats.rare, 1500);
    animateValue("epicCards", 0, stats.epic, 1500);

    const ctx = document.getElementById('rarityChart').getContext('2d');
    new Chart(ctx, {
      type: 'pie',
      data: {
        labels: ['Common', 'Rare', 'Epic', 'Legendary'],
        datasets: [{
          data: [stats.common, stats.rare, stats.epic, stats.legendary],
          backgroundColor: ['lightgray', '#3498db', '#9b59b6', 'gold']
        }]
      },
      options: {
        plugins: {
          legend: { labels: { color: '#fff' } }
        }
      }
    });
  </script>
{% endblock %}
