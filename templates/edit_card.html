{% extends "base.html" %}
{% block title %}Edit Cards{% endblock %}

{% block content %}
<div class="row">
  <!-- Sidebar -->
  <div class="col-md-3" data-aos="fade-right">
    <div class="glass-card p-3">
      <h5 class="text-light mb-4">Navigation</h5>
      <ul class="nav flex-column">
        <li class="nav-item mb-2">
          <a class="nav-link text-light" href="{{ url_for('admin_dashboard') }}">
            <i class="fas fa-chart-pie me-2"></i> Dashboard
          </a>
        </li>
        <li class="nav-item mb-2">
          <a class="nav-link text-light" href="{{ url_for('add_card') }}">
            <i class="fas fa-plus me-2"></i> Add Card
          </a>
        </li>
        <li class="nav-item mb-2">
          <a class="nav-link text-light" href="{{ url_for('history') }}">
            <i class="fas fa-clock me-2"></i> History
          </a>
        </li>
        <li class="nav-item mb-2">
          <a class="nav-link text-light fw-bold text-primary" href="{{ url_for('edit_card_list') }}">
            <i class="fas fa-edit me-2"></i> Edit Card
          </a>
        </li>
        <li class="nav-item">
          <span class="nav-link text-muted"><i class="fas fa-cogs me-2"></i> Manage (soon)</span>
        </li>
      </ul>
    </div>
  </div>

  <!-- Main Content -->
  <div class="col-md-9">
    <h1 class="page-title text-white" data-aos="fade-down">Edit Cards</h1>

    <!-- Filters -->
    <div class="row mb-4" data-aos="fade-up">
      <div class="col-md-6">
        <select id="rarityFilter" class="form-select bg-dark text-light border-secondary">
          <option value="all">All Forms</option>
          <option value="base">Base</option>
          <option value="awakened">Awakened</option>
          <option value="event">Event</option>
        </select>
      </div>
      <div class="col-md-6">
        <input type="text" id="searchInput" class="form-control bg-dark text-light border-secondary" placeholder="Search by name or ID">
      </div>
    </div>

    <!-- Card List -->
    {% for c in cards %}
      <div class="glass-card mb-3 glow-hover card-entry" data-form="{{ c.form }}" data-name="{{ c.character_name|lower }}" data-id="{{ c.id }}" data-aos="fade-up">
        <strong class="text-white">#{{ c.id }}</strong> â€” <span class="text-white">{{ c.character_name }}</span>
        <small class="text-muted">({{ c.form|capitalize }})</small><br>
        <small class="text-muted">Added: {{ c.created_at }}</small>
        <div class="float-end">
          <a href="{{ url_for('edit_card', card_id=c.id) }}" class="btn btn-sm btn-outline-light me-2">
            <i class="fas fa-edit"></i> Edit
          </a>
          <button class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteModal" data-id="{{ c.id }}" data-name="{{ c.character_name }}">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      </div>
    {% else %}
      <div class="glass-card text-center text-muted py-4" data-aos="fade-up">
        <i class="fas fa-info-circle fa-2x mb-2"></i>
        <p>No cards found.</p>
      </div>
    {% endfor %}
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-light">
      <div class="modal-header border-secondary">
        <h5 class="modal-title" id="deleteModalLabel">Confirm Deletion</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete <strong id="deleteName"></strong> (#<span id="deleteId"></span>)?</p>
      </div>
      <div class="modal-footer border-secondary">
        <form method="POST" action="{{ url_for('delete_card') }}">
          <input type="hidden" name="card_id" id="deleteInput">
          <button type="submit" class="btn btn-danger">Delete</button>
        </form>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  const filter = document.getElementById('rarityFilter');
  const search = document.getElementById('searchInput');
  const entries = document.querySelectorAll('.card-entry');

  function applyFilters() {
    const rarity = filter.value;
    const query = search.value.toLowerCase();

    entries.forEach(card => {
      const form = card.dataset.form;
      const name = card.dataset.name;
      const id = card.dataset.id;

      const matchesForm = (rarity === 'all' || form === rarity);
      const matchesSearch = name.includes(query) || id.includes(query);

      card.style.display = (matchesForm && matchesSearch) ? 'block' : 'none';
    });
  }

  filter.addEventListener('change', applyFilters);
  search.addEventListener('input', applyFilters);

  const deleteModal = document.getElementById('deleteModal');
  deleteModal.addEventListener('show.bs.modal', event => {
    const trigger = event.relatedTarget;
    const id = trigger.dataset.id;
    const name = trigger.dataset.name;

    document.getElementById('deleteId').textContent = id;
    document.getElementById('deleteName').textContent = name;
    document.getElementById('deleteInput').value = id;
  });
</script>
{% endblock %}
